<!DOCTYPE html>
<html 
    lang="en-us"
    class="no-js"
>



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">
    <meta name="description" content="docker 1.12 docker swarm docker scale docker compose docker overlayer docker Service、Stack、Cloud">
    <meta name="keywords" content="docker 1.12,docker swarm,docker scale,docker compose,docker overlayer,docker Service Stack Cloud">
    
    
    <meta name="generator" content="Hugo 0.15" />
    <meta name="generation-date" content="2016-07-31 02:46:49.761562686 &#43;0800 CST">
    <title>Docker 1.12的黑魔法 &middot; 安迪兒隨手貼</title>
    <link rel="shortcut icon" href="https://bowwow.tips/img/favicon.ico">
    <link rel="icon" href="https://bowwow.tips/img/favicon.ico">
    
<link rel="stylesheet" href="https://bowwow.tips/css/materialize.min.css">


<link rel="stylesheet" href="https://bowwow.tips/css/font-awesome.min.css">


    
    <link rel="stylesheet" href="https://bowwow.tips/css/styles/railscasts.css">



<link rel="stylesheet" href="https://bowwow.tips/css/lightbox.css">


<link rel="stylesheet" href="https://bowwow.tips/css/main.css">


    <script src="https://bowwow.tips/js/modernizr-latest.js"></script>
    <script src="https://bowwow.tips/js/lazysizes.min.js"></script>
    <script src="https://bowwow.tips/js/ls.noscript.min.js"></script>

    <script>
        window.lazySizesConfig = window.lazySizesConfig || {};
        lazySizesConfig.addClasses = true;
        lazySizesConfig.loadMode = 2;
    </script>

    
</head>


<body class="page-colors minimum-viewport-height">
    

<nav class="main-menu menu-colors">
    <ul class="menu menu-colors no-list-float">
        <li><a href="https://bowwow.tips/"><i class="fa fa-home fa-2x"></i></a></li>
        <li>
            <a href="#!"><i class="fa fa-bars fa-2x"></i></a>

            
            <ul class="menu flexible-width menu-colors no-list-float">
                
                
                    <li >
                    
                        <a href="/food/">
                            
                            <span>Food</span>
                        </a>
                    
                    </li>
                
                    <li >
                    
                        <a href="/gallery/">
                            
                            <span>Gallery</span>
                        </a>
                    
                    </li>
                
                    <li >
                    
                        <a href="/othergallery/">
                            
                            <span>Othergallery</span>
                        </a>
                    
                    </li>
                
                    <li class="active">
                    
                        <a href="/post/">
                            
                            <span>Post</span>
                        </a>
                    
                    </li>
                
                    <li >
                    
                        <a href="/project/">
                            
                            <span>Project</span>
                        </a>
                    
                    </li>
                
                    <li >
                    
                        <a href="/unboxing/">
                            
                            <span>Unboxing</span>
                        </a>
                    
                    </li>
                
            </ul>
        </li>
        <li><a href="#!" data-lightbox-id="searchbox"><i class="fa fa-search fa-2x"></i></a></li>
        
            <li class="blue-grey-text" style="border-top: 1px solid;"></li>
            
                <li>
                    <a href="#!">
                        <i class="fa fa-twitter fa-2x"></i>
                    </a>
                </li>
            
                <li>
                    <a href="#!">
                        <i class="fa fa-linkedin fa-2x"></i>
                    </a>
                </li>
            
                <li>
                    <a href="#!">
                        <i class="fa fa-google-plus fa-2x"></i>
                    </a>
                </li>
            
                <li>
                    <a href="#!">
                        <i class="fa fa-github fa-2x"></i>
                    </a>
                </li>
            
        
        <li class="blue-grey-text" style="border-top: 1px solid;"></li>
        <li>
            <a href="" type="application/rss+xml" target="_blank">
                <i class="fa fa-rss fa-2x"></i>
            </a>
        </li>
    </ul>
</nav>

<div id="searchbox" class="no-display">
    <div class="valign-wrapper fill-container">
        <div class="valign large-form horizontal-center-hack">
            <form method="get" id="search" action="http://duckduckgo.com/">
    <input type="hidden" name="sites"value="https://bowwow.tips/"/>
    <input type="hidden" name="ka" value="h"/>
    <input type="hidden" name="k7" value="#fafafa"/>
    <input type="hidden" name="kj" value="#3f3f3f"/>
    <input type="hidden" name="ky" value="#fafafa"/>
    <input type="hidden" name="kx" value="b"/>
    <input type="hidden" name="kt" value="Helvetica"/>
    <input type="text" name="q" maxlength="255" placeholder="Search"/>
    <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
</form>


        </div>
    </div>
</div>




    <div class="main-content">
        <div class="center-space">
            <div class="article-colors">
                
                <article>
                    <header>
                        <h1 class="article-title">Docker 1.12的黑魔法</h1>
                        <time class="date-color">Sat Jul 30, 2016</time>
                        <span class="separator">|</span>
                        
<ul class="categories">
    <li>
        <i class="fa fa-book"></i>
    </li>
    
        <li><a href="https://bowwow.tips/categories/tips">tips</a></li>
    
</ul>


                        <span class="separator">|</span>
                        
<ul class="tags">
    <li>
        <i class="fa fa-tags"></i>
    </li>
    
        <li><a href="https://bowwow.tips/tags/docker">docker</a></li>
    
</ul>


                    </header>

                    <hr>

                    <section>
                        
                            

<p>今年2016 Docker Conf 發表後，引起大家狂熱的討論，會場整個都高潮了~XD<br />
引用一下相關的結論文章<br />
DockerCon 2016會議：發布內容的總結及主要收穫
原文網址：<a href="https://kknews.cc/tech/mmx4yp.html">https://kknews.cc/tech/mmx4yp.html</a></p>

<p>Docker Swarm 已死！Docker Swarm 萬歲！
原文網址：<a href="https://kknews.cc/tech/8e2egq.html">https://kknews.cc/tech/8e2egq.html</a></p>

<p>###官方無敵威的展示影片
<iframe width="420" height="315" src="https://www.youtube.com/watch?v=F7hoq0KwHD4" frameborder="0" allowfullscreen></iframe></p>

<p>看完影片後，安迪兒超期待7月新版的發表
迫不急待的試玩一下，也想把系統由舊的swarm更換成新的docker swarm<br />
就這樣一路從Docker1.12 rc2 rc3 rc4都玩了一遍<br />
(因為不少問題和bug，所以才會一直試到rc4 &hellip;orz)</p>

<p>終於今天Docker v1.12.0正式定版了<br />
大大們開發的能量超強大，每一版都更新很表，也修了一大堆東西~XD<br />
<a href="https://github.com/docker/docker/releases">https://github.com/docker/docker/releases</a></p>

<p>安迪兒也立馬全新安裝，順便記錄一下和分享試用Docker 1.12的心得</p>

<p>這次的docker其實增加很多的新功能(docker真的進化超快的~XD)</p>

<h3 id="swarm:e75d3bee28da3e2ece5c132dc361a283">Swarm</h3>

<p>安迪兒其實是為了這個功能，才會一直的在try
因為舊版的Swarm其實有點麻煩<br />
要建置Consul Key Store daemon
要建overlay的網路
還要再自已寫一堆腳本去監控和偵測狀態和處理的方式</p>

<p>而新版的docker 1.12超神奇，整個Swarm整合進去<br />
也有了新的docker Swarm cluster使用和管理方式<br />
大大的簡化了cluster的設置</p>

<h3 id="docker-service-stack-cloud:e75d3bee28da3e2ece5c132dc361a283">Docker Service、Stack、Cloud</h3>

<p>整合stack與service的管理，可以使用deploy把stack部署到cloud上</p>

<h3 id="health-check:e75d3bee28da3e2ece5c132dc361a283">Health check</h3>

<p><a href="https://github.com/docker/docker/pull/23218">https://github.com/docker/docker/pull/23218</a><br />
可以自訂節點的健康
&ndash;health-cmd (health用的指令檔)
&ndash;health-interval (health的秒數)
然後用一般的docker inspect就可以查詢check的結果</p>

<pre><code>docker inspect --format='' xxname healthy
</code></pre>

<h3 id="live-restore:e75d3bee28da3e2ece5c132dc361a283">Live restore</h3>

<p><a href="https://github.com/docker/docker/pull/23213">https://github.com/docker/docker/pull/23213</a><br />
啟動時增加這個參數，daemon掛了也不會影響到container
&ndash;live-restore</p>

<h3 id="overlay2:e75d3bee28da3e2ece5c132dc361a283">overlay2</h3>

<p><a href="https://github.com/docker/docker/pull/22126">https://github.com/docker/docker/pull/22126</a><br />
裡面有benchmark的數據可以參考一下</p>

<p>其它還有很多細的東西、指令、參數之類<br />
有興趣的，可以多查查官方的說明<br />
看了這些，應該手癢了吧</p>

<p>[以下是實作時間嘍]</p>

<h4 id="1-安裝新版docker-for-1-12:e75d3bee28da3e2ece5c132dc361a283">1. 安裝新版docker for 1.12</h4>

<p>參考這頁的說明<br />
<a href="https://github.com/docker/docker/releases">https://github.com/docker/docker/releases</a></p>

<p>執行安裝指令</p>

<pre><code>curl -fsSL https://experimental.docker.com/ | sh
</code></pre>

<pre><code>sudo usermod -aG docker andy
</code></pre>

<p><img src="https://goo.gl/EMIf5a" width="50%">
<img src="https://goo.gl/zogzGo" width="50%"></p>

<h4 id="2-玩玩container的叢集-建一個swarm來玩玩吧:e75d3bee28da3e2ece5c132dc361a283">2. 玩玩Container的叢集，建一個swarm來玩玩吧</h4>

<p>首先在master機器上，建立管理的節點</p>

<pre><code>docker swarm init --listen-addr docker112-swarm-admin:2377
</code></pre>

<p><img src="https://goo.gl/ymP7Z4" width="50%"></p>

<p>再來在其它不同的node機器上輸入</p>

<pre><code>docker swarm join \
 --token SWMTKN-1-55xrvnhhax0eqc0hi4iu6aihh8msqvlfjdgqetaqvlf8qm4n0z-7ekdghz9an5d4jpx4ibdaigtx \
 10.240.0.3:2377
</code></pre>

<p><img src="https://goo.gl/CjM4D4" width="50%">
都加入完了之後，在主節點，master那台<br />
可以下</p>

<pre><code>docker node ls
</code></pre>

<p><img src="https://goo.gl/hPGhT6" width="50%"></p>

<p>看看，超神奇的，就這樣一個跨機器的Container cluster就立完成了<br />
這是不是docker的 <strong>黑魔法</strong> 吶~~~太可怕了，合併swarm後簡化許多繁雜的東西</p>

<h4 id="3-建個自已用的network:e75d3bee28da3e2ece5c132dc361a283">3. 建個自已用的network</h4>

<p>用docker network 建立一個自已的overlay來玩玩<br />
建完並指定Container的overlay後，Container就能視為同網段，跨各種機器運行了</p>

<pre><code>docker network create --driver overlay bowwow-net  
</code></pre>

<p><img src="https://goo.gl/xY51ig" width="50%"></p>

<h4 id="4-來見識一下讓大家瘋狂的神奇docker-service威力吧:e75d3bee28da3e2ece5c132dc361a283">4. 來見識一下讓大家瘋狂的神奇Docker Service威力吧</h4>

<p>建個postgresql database，直接replicas 2台<br />
2台都是同樣的database</p>

<pre><code>docker service create --replicas 2 -p 5432:5432 -p 8000:5432 --name=postgresql --network=bowwow-net --env=&quot;constraint:node==docker-swarm-node1&quot; --mount type=volume,source=/home/app/metadb,target=/var/lib/postgresql -e POSTGRESQL_USER=postgres -e POSTGRESQL_PASS=1234 -e POSTGRESQL_DB=demodb bowwow/posttgresql9.4
</code></pre>

<pre><code>docker service ls
</code></pre>

<p><img src="https://goo.gl/Vb5Xax" width="50%"></p>

<p>可以看到postgresql啟動完成，2台分散在不同的機器上</p>

<p>直接來玩一下，2台機器的postgresql同時都能連上<br />
<img src="https://goo.gl/6W7Eox" width="50%"></p>

<p>隨便改一下其中一台，建一個新的table<br />
<img src="https://goo.gl/6W7Eox" width="50%"></p>

<p>過一下另一台就跟都同步了<br />
<img src="https://goo.gl/gWsS1S" width="50%"><br />
而且因為用了bowwow-net的關係<br />
開三台機器，三台機器都能互相找的到<br />
也就是說，連上3台機器的ip，都能接上這個postgresql db<br />
但這個postgresql db是分散成2個Container在跑<br />
<strong>docker都幫你做了ha、scale和cluster了</strong><br />
<strong>只能說:超~~<del>神</del>~的吶</strong></p>

<p>玩一下隨興的新增和刪除Container節點</p>

<pre><code>docker service ps postgresql
docker service scale postgresql=3
docker service scale postgresql=1
docker service update --replicas 2 postgresql
</code></pre>

<p>新版docker還可以rolling update服務
&ndash;update-delay<br />
他會慢慢的更版，不會一次都換掉<br />
ex:</p>

<pre><code>docker service create \
  --replicas 3 \
  --name redis \
  --update-delay 10s \
  redis:3.0.6
</code></pre>

<p>試一下Swarm Container Cluster移轉的功能<br />
惡意關掉&amp;刪除其中一台的postgresql Container
<img src="https://goo.gl/xVWrW9" width="50%">
<img src="https://goo.gl/EiFWMM" width="50%"></p>

<p><strong>果然夠優~馬上又自動的在別台機器上重啟了一個相同的服務</strong></p>

<p>一次開10個來玩玩吧
<img src="https://goo.gl/fDCI28" width="50%"></p>

<p>不想要服務了，刪除它</p>

<pre><code>docker service rm postgresql
docker service ls
</code></pre>

<p><img src="https://goo.gl/pYzbDR" width="50%"></p>

<p>新的Docker以上這些功能<br />
跟本就是有k8s(Kubernetes)的影子<br />
連相關指令名稱都有點相近<br />
難怪大家整個看到傻眼，進化後太強大了。</p>

<h4 id="5-部署docker-stack:e75d3bee28da3e2ece5c132dc361a283">5. 部署Docker Stack</h4>

<p>大至上看起來<br />
新的docker swarm像是用service就可以處理&amp;管理相關的container服務<br />
如果想用之前compose之類的一次啟動管理的方式呢??
安迪兒找了找，發現docker有一個deploy的相關功能<br />
看了他文字上有說，要用dab來部署<br />
忍不住好奇試了一下，真的是可以用</p>

<p>首先先裝上最新版的docker-compose(1.8)<br />
參考這頁<br />
<a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a></p>

<pre><code>curl -L https://github.com/docker/compose/releases/download/1.8.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose  
</code></pre>

<p><img src="https://goo.gl/6dB7jy" width="50%"></p>

<p>編寫一下docker-compose file<br />
啟動它，成功後，可以自行bundle成dab檔<br />
轉成用docker deploy去部署它</p>

<pre><code>sudo docker-compose up -d
sudo docker-compose bundle -o elk.dab
docker deploy elk
</code></pre>

<p><img src="https://goo.gl/Jfuq9q" width="50%"><br />
<img src="https://goo.gl/FlZqKI" width="50%"><br />
<img src="https://goo.gl/mqRVTu" width="50%"></p>

<p>看一下結果吧<br />
<img src="https://goo.gl/Cr71Mu" width="50%"><br />
<img src="https://goo.gl/QERLf3" width="50%"></p>

<p>呼<del>終於，東西實在太多了，安迪就也沒辦法一次說完試完<br />
總之，這次的docker 1.12非常的強大<br />
如果想要有較簡易的，除了k8s或mesos另外選擇的<br />
也許考慮一下原生的docker看看嘍<br />
應該不會失望的</del>~XD<br />
收工嘍~收工嘍!</p>

                        
                    </section>

                    <footer class="right-align">
                        <p><small>Copyright &#169; by 安迪兒</small></p>
                    </footer>

                    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'bowwowtips';
        var disqus_identifier = 'https:\/\/bowwow.tips\/post\/20160730\/';
        var disqus_title = 'Docker 1.12的黑魔法';
        var disqus_url = 'https:\/\/bowwow.tips\/post\/20160730\/';
        (function() {
            
            if (window.location.hostname === "localhost") {
                return;
            }

            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            (document.getElementsByTagName('head')[0] ||
                document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


                </article>
            </div>
        </div>
    </div>

    
<script src="https://bowwow.tips/js/jquery-2.1.4.min.js"></script>


<script src="https://bowwow.tips/js/materialize.min.js"></script>


<script src="https://bowwow.tips/js/imagesloaded.pkgd.min.js"></script>


<script src="https://bowwow.tips/js/masonry.pkgd.min.js"></script>


    
    <script src="https://bowwow.tips/js/highlight.pack.js"></script>



<script src="https://bowwow.tips/js/lightbox.min.js"></script>


<script src="https://bowwow.tips/js/jquery.infinitescroll.min.js"></script>


<script src="https://bowwow.tips/js/main.js"></script>


<script src="https://bowwow.tips/js/small.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78436139-1', 'auto');
  ga('send', 'pageview');

</script>

</body>

</html>





